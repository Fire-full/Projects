class "Макет";   --Макет   ТабличныйДокумент.

Import СИС2          Classes Константы ;
--Import ТаблДокумент  Classes ТабличныйДокумент, Области, Область, Параметры, Структуры, Функции;
Import ТаблДокумент  Classes ТабличныйДокумент, Параметры, Структуры, Функции;

-- Интересные Функц!!!!
Import СИС2 Classes Функции ;
-- Интересные Функц!!!!

inclass Public

2--Поля РазыменованиЯ
var ТабДок              : ТаблДокумент.ТабличныйДокумент;     --
--var Област2ь0             : ТаблДокумент.Област2ь0;     --
--var Области             : ТаблДокумент.Области;     --
var Параметры           : ТаблДокумент.Параметры;   --
var Структура           : ТаблДокумент.Структуры;   -- ?????
2--.........
2--.........
2--Поля РазыменованиЯ

inobject Public


inclass Public

 lClass                  : Класс BlankForm;    --var
-- ФреймШаблонаПолучателя  : ФреймШаблона;       --var
 КоличСекцНаФрейме       : integer;            --var
 ТекущКласс              : Вариант;            --var

 БланкМакета             : BlankForm;          --var
 БланкПриемник           : BlankForm;          --var

 источникSec             : TemplateSection;    --var
 получательSec           : TemplateSection;    --var

 хКолРядов               : integer;            --var
 хКолСтолбцов            : integer;            --var
 ПервыйВызовОбласти      : Логическое;         --var

 ТекВысота               : integer;            --Текущая высота Табличного документа
 ТекСтрока               : integer;            --Текущая Строка Табличного документа
 ТекСтолбец              : integer;            --Текущая Столбец Табличного документа
 ТекСтлбОбл              : integer;            --Текущая Стлб Обл Табличного документа
 ТекСтрОбл               : integer;            --Текущая Строка Обл Табличного документа

2    0--Принтер
 ВысотаБумаги            : integer;           --var
 ШиринаБумаги            : integer;           --var
 АльбомныйЛист           : Логическое;        --var
2    0--Принтер

--Служебные Секции и их Параметры

----    КолонтитулЫ
 ВерхнКолонтитулSec       : TemplateSection;   --var
 ВыводитьВерхнКолонтитул  : Логическое;        --var

 НижнКолонтитулSec        : TemplateSection;   --var
 ВыводитьНижнКолонтитул   : Логическое;        --var
 2--0  КолонтитулЫ

2--0Заголовок2 0Страниц
 ЗаголовокСтраницSec      : TemplateSection;   --var
 ВыводитьЗаголовокСтраниц : Логическое;        --var
 хКолРядовЗаголовка       : integer;           --var
 хКолСтолбцовЗаголовка    : integer;           --var
2--0Заголовок2 0Страниц

2--0Итог2 0На2 0Странице
 ИтогиСтраницSec          : TemplateSection;   --var
 ВыводитьИтогиСтраниц     : Логическое;        --var
 2Не0ВыводитьИтогНа2Посл0Странице   : Логическое;  --var
 хКолРядовИтоги           : integer;           --var
 хКолСтолбцовИтоги        : integer;           --var
--2-- 0Итог2 0На2 0Странице

--Служебные Секции и их Параметры

 СтруктураПолейЗаполнена  : Логическое;         --  var
 ДанныеПолейЗаполнены     : Логическое;         --  var

 ВСтандартныйБланк        : Логическое;         --  var
--var
--var
--var

масСоответствие           : Вариант[2];  2    0   --2 0Соответствие Имя Секции и Подтаблицы приемника
масПоляСтруктур           : Вариант[2];  2    0   --2 0Соответствие Названия поля и его Значения

Данные synonym facts      : Вариант[2];  2    0   --2 0Соответствие Названия поля и его Значения

inclass Public

  func Создать synonym Create :2 0Макет;
     Result = inherited Create;
     Result.Init;
     Result.ТабДок           = ТабличныйДокумент.Create;
     Result.Параметры        = ТаблДокумент.Параметры.Create;
     Result.Параметры.Хозяин = Self; -- Self
     --Result.Област2ь0          = ТаблДокумент.Област2ь0.Create;
    -- Result.Област2ь0.Хозяин   = Self; -- Self
     --Result.Области          = ТаблДокумент.Области.Create;
     --Result.Области.Хозяин   = Self; -- Self
     Result.Структура        = ТаблДокумент.Структуры.Create;
     Result.Структура.Хозяин = Self; -- Self


  end ;

inobject Public

  proc Init;
     ОчиститьПеременные;
  end ;

inclass Public

  proc ОчиститьПеременные;
   -- мас2Области0              = nil;
    Данные                  = nil;
    Фреймы                  = nil;
    масПоляСтруктур         = nil;
    масСоответствие         = nil;
    СтруктураПолейЗаполнена = Ложь;
    ДанныеПолейЗаполнены    = Ложь;
    ПервыйВызовОбласти      = Истина;
    ВСтандартныйБланк       = Ложь;
    ВысотаБумаги            = 0;
    ШиринаБумаги            = 0;
    хКолРядов               = 0;
    хКолСтолбцов            = 0;
    БланкМакета             = nil;
    БланкПриемник           = nil;


  end;
  --------------------------------------------------------------------
  func ПолучитьМакет          (БланкШаблона: Строка = "") : Вариант;
    var BlTemp    : BlankForm;

--  Макет - это "Место" (Шаблон бланка) где нарисованы секции, колонки, строки и клетки которые будут
--  ОБРАЗЦОМ (ПроОбразом) для копирования!
--  Все объекты Макета имеют - Цвет, Шрифт, размер такой какой нужно, Видимость или не видимость определяется тоже здесь.
--  При необходимости изменить один или несколько параметров, переходим в шаблон макета и там правим.
--  Код Класса "Макет" при этом - не изменяется!

    ТекущКласс    = Self.Создать;

    Если БланкШаблона="" Тогда
      lClass            = СИС2.ФункцииКонсоли.НайтиФормуБланка("ТабличныйБланк");   --"ТабличныйБланк.tpl"
      БланкМакета       = lClass.Создать;
      масСоответствие   = nil;
      БланкПриемник     = БланкМакета;
      ВСтандартныйБланк = Истина;
    Иначе
      -- Внешний "*.tpl"-бланк с "данными" или "шаблоном".
      Если Match(БланкШаблона, "*.tpl") Тогда -- Внешний бланк с данными. Его нужно как-то инициализировать...
        lClass                   = СИС2.ФункцииКонсоли.НайтиФормуБланка("ВременныйБланк");
        БланкМакета              = lClass.Создать;
        БланкМакета.ПутьКДопШабл = БланкШаблона; --Передаём путь к шаблону для его подгрузки.
      Иначе  -- Бланк Проекта с "данными" или "шаблоном".
        lClass          = СИС2.ФункцииКонсоли.НайтиФормуБланка(БланкШаблона);
        БланкМакета     = lClass.Создать;
        масСоответствие = БланкМакета.масСоответствие как Вариант[2];
        --Определить каким бланком открыт "Этот" Класс!!!
        БланкПриемник   = (СИС2.ФункцииКонсоли.НайтиФормуБланка(БланкМакета.БланкЗаказчик)).Создать; -- Создали новый экземпляр (Он второй)
        BlTemp          = БланкПриемник; БланкПриемник = nil;                                        -- Переназначаем и удаляем второй.
        БланкПриемник   = BlTemp.Objects[1];                                                         -- Работаем только с первым бланком (Бланк, который запустил этот бланк)!!!
      Илсе;
    Илсе;

    ВзятьВсеФреймы2Бланка0                 (БланкМакета.Шаблон2.0RootFrame2, 0Фреймы);       -- Массив всех Фреймов в Бланке
    ЗаполнитьПоИменованныеОбъектыШаблона (мас2Области0, Фреймы);

    если Структура.ЕстьДанные() Тогда
       Данные = Структура.ВзятьДанные();
    конец;

    Фреймы    = Nil;
    Результат = ТекущКласс;    -- Пока не знаю что возвращать      ТекущКласс.Objects[210]

  end;
  --------------------------------------------------------------------
inobject Public
  --------------------------------------------------------------------
  func ПолучитьОбласть        (имяСекции : Строка = ""; Var Sec : TemplateSection = nil) : 2Вариант0; --Должна возвращать "ТабличныйДокумент"
    var i                   : Integer;
    var ТекущОбластьПечати  : ТабличныйДокумент;
    var ТабДок              : ТабличныйДокумент;
--                    Область - это отдельная Секция со своим набором строк(или одной строки) и колонок(или одной колонки).
--                    Область имеет свои свойства и методы характеризующие её.
--                    При вызове этой Функции, добавляется НОВАЯ секция и эта секция становится "текущей" (получательSec)
--                           получательSec = ФреймШаблонаПолучателя.AddSection;
--                           ФреймШаблонаПолучателя.SectionsCount;
      получательSec   = nil;
      источникSec     = nil;
      масПоляСтруктур = nil;
      ТекСтрОбл       = 0  ;   --??????

         --Создаем "приемник" для области
      ТабДок          = ТабличныйДокумент.Create;


      Если имяСекции="" Тогда
        имяСекции="секПриемник";
      Илсе;
        i = SearchInArray ( мас2Области0[1], Up(имяСекции) );   --По имени поля находим значение в массиве
        Если i=-1 Тогда
            Сообщение("Область загрузки - '"+имяСекции+"' - не найдена!");
            Результат = nil;
            ВОЗВРАТ Результат;
        Иначе
            источникSec  = мас2Области0[2,I];
            хКолРядов    = источникSec.RowsCount;
            хКолСтолбцов = источникSec.ColumnsCount;

            2ТекущОбластьПечати0 2= 0ТабличныйДокумент2.0Create2;
            --2ТекущОбластьПечати0.Current = источникSec;
            2ТекущОбластьПечати0.Обновить;

            ТабДок.ФреймШаблонаПолучателя = мас2Области0[3,i];
            если ПервыйВызовОбласти тогда
               КоличСекцНаФрейме  = ТабДок.ФреймШаблонаПолучателя.SectionsCount;
               ПервыйВызовОбласти = Ложь;
            Илсе;
        end;

    Результат = 2ТекущОбластьПечати0; -- Пока не знаю что возвращать

  end;

inclass Public

  Функ РисуемСтрокуВСекции    (y:Целое; перем СтрокаСек:Строка="ИмяСтроки"; ИтогиСтраницSec : TemplateSection) : TemplateSection;
      ПолучитьСтрокуСекцииПоИмени (ИтогиСтраницSec, СтрокаСек);
  end;
  Функ РисуемСтолбецВСекции   (x:Целое; перем СтрокаСек:Строка="ИмяСтолба"; ИтогиСтраницSec : TemplateSection) : Вариант;
      ПолучитьСтолбецСекцииПоИмени(ИтогиСтраницSec, "ИмяСтолба");
  end;
  Функ ВернутьЗначениеПоля    (Надпись : Вариант ) : Вариант ;
    var i    : Целое;
    var Надп : Строка;

      Если   VarType(Надпись) = varString  Тогда
             Надп = Надпись ;
      ЕслиЖе VarType(Надпись) = varObject  Тогда
             Надп = Надпись.Содержимое ;
      ЕслиЖе VarType(Надпись) = varInt     Тогда
             Результат = масПоляСтруктур[2, Надпись];
             ВОЗВРАТ Результат;
      Илсе;
      i = SearchInArray ( масПоляСтруктур[1], Up(Надп) );   --По имени поля находим значение в массиве
      Если i=-1 Тогда
          Результат = nil;
      Иначе
          Результат = масПоляСтруктур[2,I];
      end;

  Кнуф;

  func РисуемОбласть          (2var locSec :Вариант=NIL ; 0var  ii : integer=200 ) : Вариант;
     var Sec   2         0:2 0TemplateSection;
     var ThisCell2       0:2 0TemplateCell;
     var ThisTargetCell :2 0TemplateCell;
     var j,k, RowsКолич, ColumnsКолич : Integer;
        Если 2 locSec = NIL0 Тогда
        2  0Sec 2 0= источникSec;
        2Иначе
          Если VarType(2locSec0) = varObject Тогда
            Sec 2 0= 2locSec0.Current;
          Илсе;
        Илсе;
        Если ii=0 Тогда           --Если "0", то это не повторяющ секция! "Заголовок", "Итог"...
          получательSec = ТабДок.ФреймШаблонаПолучателя.AddSection;      -- новая секция
  2        получательSec.Assign(Sec);                        0      2-- Копируем свойства секции
          --получательSec.Имя = Sec.Имя;
        Иначе
          Если получательSec = 2NIL0  Тогда
            if ВСтандартныйБланк then
              Если ТабДок.ФреймШаблонаПолучателя.КоличествоСекций = 1 Тогда
                Если  ТабДок.ФреймШаблонаПолучателя.Section[1].КоличествоСтрок=1 и ii=1 Тогда
                  получательSec = ТабДок.ФреймШаблонаПолучателя.Section[1];    -- секция
        2        0  2получательSec.Assign(Sec);0                            2-- Копируем свойства секции
                2Иначе
                  получательSec = ТабДок.ФреймШаблонаПолучателя.Section[1];    -- секция
        2        0  2получательSec.Assign(Sec);0                            2-- Копируем свойства секции
                Илсе;
              Илсе;
            2Иначе
              получательSec = ТабДок.ФреймШаблонаПолучателя.AddSection;    -- новая секция
    2        0  2получательSec.Assign(Sec);0                            2-- Копируем свойства секции
            end;
          2Иначе
            if ВСтандартныйБланк then
              Если получательSec.RowsCount < ii Тогда      --получательSec.Count
                получательSec.InsertRow(ii)2;0 -- новая строка в секции
              Илсе;
            2Иначе
              получательSec = ТабДок.ФреймШаблонаПолучателя.AddSection;    -- новая секция
    2        0  2получательSec.Assign(Sec);0                            2-- Копируем свойства секции
              получательSec.Имя = Sec.Имя+ "_" + Str( ii );
              --получательSec.InsertRow(2Sec0.RowsCount)2;
            Илсе;
          Илсе;

        Илсе;

        ColumnsКолич = получательSec.ColumnsCount;
        RowsКолич   2 0= получательSec.RowsCount;

        Если ВыводитьИтогиСтраниц Тогда
            ТекВысота = ВернутьВысотуСтрок (получательSec);
        Илсе;
        if ВСтандартныйБланк then
--          TempRow = получательSec.Row[RowsКолич]2;
--          for j=1..RowsКолич  do                   2    0 2  0        -- цикл по всем строкам секции "_ИСТОЧНИК."
            for k=1..ColumnsКолич do             2  0 2      0        2  0-- цикл по колонкам 2    0секции "_ИСТОЧНИК."
              ThisTargetCell = получательSec.Cell[k, RowsКолич];
              if ThisTargetCell.CellType   = Ядро.Template.StaticText then
               2  0ThisTargetCell.Содержимое2 0= ВернутьЗначениеПоля(k);
              end;
            Od;
--          Od;
        Иначе
          for j=1..RowsКолич  do                   2    0 2  0-- цикл по всем строкам секции "_ИСТОЧНИК."
            for k=1..ColumnsКолич do             2  0 2      0-- цикл по колонкам 2    0секции "_ИСТОЧНИК."
              ThisTargetCell = получательSec.Cell[k, j];
              if ThisTargetCell.CellType  = Ядро.Template.StaticText  then
                --Клетка не является полем!!!
                --Обработку не проводим. Оставляем всё как есть.
              Иначе
                if ThisTargetCell.ReadOnly then
  2                Проверка(0ThisTargetCell.ReadOnly2, "Для Секции:'" + 0получательSec.2Имя + "', 0ThisTargetCell2[" + 0Str(k)2 + ":" + 0Str(j)2+ "] имеет свойство - ТОЛЬКО ДЛЯ ЧТЕНИЯ!");
                Иначе
              2    0ThisCell   2               0= Sec.Cell  [k,j];
                  ThisTargetCell            = ThisCell;
                  if ii  = 0  then
                2  0  ThisTargetCell.Содержимое2 0 = ВернутьЗначениеПоля(ThisCell.Содержимое);
                  Иначе
                  2  0ThisTargetCell.Содержимое2 0 = ThisCell.Содержимое+"["+Str( ii )+"]"; -- Нпп[1]
                    ThisTargetCell.Text;
                  end;
                end;
              end;
            Od;
          Od;
        end;
  end;

  func УдалитьНарисованныеСекции  : Логическое;

    if ТабДок.ФреймШаблонаПолучателя = nil then
    Иначе
      if ТабДок.ФреймШаблонаПолучателя.SectionsCount=1 then
      Иначе
        Пока  КоличСекцНаФрейме < ТабДок.ФреймШаблонаПолучателя.SectionsCount ЦИКЛ
          ТабДок.ФреймШаблонаПолучателя.DeleteSection(ТабДок.ФреймШаблонаПолучателя.SectionsCount);
        end;
      end;
    end;

  end;

  func Закрыть : integer;
        -- OpenBlank("ТабличныйБланк", Window.ModalWindow );
    var F: BlankForm;  -- BlankForm     Импорт_ТД.Импорт_ТД.блРедакторВыражений
    var Frame : TemplateFrame;
    var i : Integer;
    var Sec   2         0:2 0TemplateSection;

    F = БланкПриемник.Создать;
    КоличСекцНаФрейме = ТабДок.ФреймШаблонаПолучателя.SectionsCount;
    Frame = F.Template.FrameByName[мас2Области0[4,1]];   --.Секция[3].Имя

    БланкПриемник.template.BeginModify;

    for i=1..КоличСекцНаФрейме  do
      if КоличСекцНаФрейме = Frame.SectionsCount и КоличСекцНаФрейме=1 then
         if Frame.SectionsCount = 1 then
           Sec = Frame.Section[1];   --Template.CurrentFrame.Section[1]
  2      0   Sec2.Assign(0ТабДок.ФреймШаблонаПолучателя.Секция[i]2);     -- Копируем свойства секции
         end;
      Иначе
        Sec = Frame.AddSection;                           -- новая секция         Frame.SectionsCount
  2      0Sec2.Assign(0ТабДок.ФреймШаблонаПолучателя.Секция[i]2);     -- Копируем свойства секции
      end;
    Od;

    БланкПриемник.template.EndModify;

    if F.Выполнить = cmOK then
      Результат = 1 ;
    Иначе
      Результат = 0 ;
    end;
    F.секПриемник=Nil;
    F = Nil;

  end;
  func ВыводимОбласть         (2var locSec :Вариант=NIL ; 0Var  ii : integer=200) : integer;

      РисуемОбласть (2locSec,0 ii);

  end;
  func КомандаАПИ             (парам1:Строка) : integer;
    Перем Shell : AutoObject;
    Shell = AutoObject.Create("WScript.Shell");
    Shell.Run(парам1);
    --Исскуственно вводимая задержка, для того чтобы предыдущая команда успела завершить свое выполнение
    --и вывела выходные данные в файл, если это требуется (на сохранение файла необходимо порядка 30 мс)
    Shell = AutoObject.Create("WScript.Shell");
    Shell.Run("ping -n 1 -w 1000 1.1.1.1",0,-1);

  end;
  func ShellProperties: integer;
    --Получение параметров принтера и запись их в файл:
    --rundll32 printui.dll,PrintUIEntry /f "results.txt" /Xg /n "printer"
    Перем LabelPrinter :Строка;
        LabelPrinter = '"'+Printer.CurrentPrinter+'"';
        КомандаАПИ('rundll32 printui.dll,PrintUIEntry /f "c:\results.txt" /Xg /n '+ LabelPrinter+ ' '); --В Командной строке +++!!!
  end;

inobject
---
---
end