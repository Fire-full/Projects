class inherited МашинаРеквизитов.Базовые.интЗапись "";

  Import      Classes РаботаСКартотеками;



inclass

--inobject

Функ ПолучитьОВЗНаД(Дат :Дата; Зван :Запись):Число;
  Перем Рез :Число;
  Перем РабОбл, РабОблОкл : Вариант;
    РабОблОкл = ОткрытьМассив(Зван, 1, "ОКЛАДВЗ", "ДАТАОВЗ", "ДАТАОВЗ<="+Стр(Дат));
    Если Записей(РабОблОкл)>0:
      Рез=ВзятьПолеЧ(РабОблОкл,Записей(РабОблОкл),"ОВЗ");
    Илсе;
    ЗакрытьРабочуюОбласть(РабОблОкл);
  Возврат Рез;
Кнуф;

Функ ОкладЗваниеЗаПериод(Звание :Запись; ДатН :Дата; ДатК :Дата):Число;
 Перем РабОблЗ,РабОблОкл : Вариант;
 Перем ИтерС,ИтерК       : Целое;
 Перем ДН,ДК             : Дата ;
 Перем Проп,Окл1,Окл2    : Число;

   Если Звание <> Nil Тогда
     --Сокращаем время расчета
     Окл1 = ПолучитьОВЗНаД(ДатН, Звание);
     Окл2 = ПолучитьОВЗНаД(ДатК, Звание);
     Если (Окл1 = Окл2) и (Окл1>0) Тогда
       Возврат Окл1;
     Илсе;
     --Сокращаем время расчета
     РабОблОкл = ОткрытьМассив(Звание, 1, "ОКЛАДВЗ", "ДАТАОВЗ", "ДАТАОВЗ<="+Стр(ДатК));
     Попытка
      --УстФильтр(РабОблОкл,"ДАТАОВЗ<="+Стр(ДатК));
      ИтерК = Записей(РабОблОкл);
      Для ИтерС = 1..ИтерК Цикл
         ДН = ВзятьПолеД(РабОблОкл, ИтерС, "ДАТАОВЗ");
         Если ДН=01.01.100 :
          Если ИтерС<ИтерК :
           Если ВзятьПолеД(РабОблОкл,ИтерС+1,"ДАТАОВЗ")<=ДатН:
            ДН=ДатК+1;
           Иначе
            ДН=ДатН;
           Илсе;
          Иначе
           ДН=ДатН;
          Илсе;
         Илсе;
         Если ИтерС<ИтерК:
          ДК = ВзятьПолеД(РабОблОкл,ИтерС+1,"ДАТАОВЗ")-1;
         Иначе
          ДК=ДатК;
         Илсе;
         Если ДН<=ДатК И ДК>=ДатН:
            Если ДН<ДатН:
             ДН=ДатН;
            Илсе;
            Если ДК>ДатК:
             ДК=ДатК;
            Илсе;
            Проп = Проп + ВзятьПолеЧ(РабОблОкл, ИтерС, "ОВЗ")*(ДК-ДН+1);
         Илсе;
      Лкиц;
     Окончание
      ЗакрытьРабочуюОбласть(РабОблОкл);
     Конец;
   Илсе;

 Возврат Проп/(ДатК-ДатН+1);

Кнуф;

Функ РасчетОВЗ(Сотр :Запись;ДатН :Дата; ДатК :Дата):Число;
 Перем РабОблЗ :Запрос;
 Перем ИтерС,ИтерК :Целое;
 Перем ДН,ДК,ДатУ,ДатК1    :Дата;
 Перем Проп                :Число;

     ДатУ=ВзятьКартПолеД("Zik_Гарнец.Справочники.Сотр_Звания", Сотр, "ДАТАУВОЛЬНЕНИЯ");
     Если ДатУ<>01.01.100:
      Если ДатУ<ДатН:
       Возврат 0;
      Илсе;
      Если ДатУ<=ДатК:
       ДатК1=ДатУ;
      Иначе
       ДатК1=ДатК;
      Илсе;
     Иначе
      ДатК1=ДатК;
     Илсе;
     Попытка
      РабОблЗ = ОткрытьРабочуюОбласть("Zik_Гарнец.Справочники.Сотр_Звания", "ДАТАПРИСВОЕНИЯ", "ДАТАПРИСВОЕНИЯ<="+Стр(ДатК1)+" И Сотр="+Стр(Сотр));
      ИтерК=Записей(РабОблЗ);
      Для ИтерС=1..ИтерК Цикл
       ДН=ВзятьПолеД(РабОблЗ,ИтерС,"ДАТАПРИСВОЕНИЯ");
       Если ИтерС<ИтерК:
        ДК=ВзятьПолеД(РабОблЗ,ИтерС+1,"ДАТАПРИСВОЕНИЯ")-1;
       Иначе
        ДК=ДатК1;
       Илсе;
       Если ДН<=ДатК1 И ДК>=ДатН:
        Если ДН<ДатН:
         ДН=ДатН;
        Илсе;
        Если ДК>ДатК1:
         ДК=ДатК1;
        Илсе;
        Проп = Проп + ОкладЗваниеЗаПериод ( ВзятьПолеЗ(РабОблЗ, ИтерС, "ЗВАНИЕ"), ДН, ДК)*(ДК-ДН+1);
       Илсе;
      Лкиц;
     Окончание
      ЗакрытьРабочуюОбласть(РабОблЗ);
     Конец;
   Возврат Проп/(ДатК-ДатН+1);
Кнуф;

-------------------------------------------------------------------------------------
Функ ЗваниеЕсть (Сотр :Запись; ДатК :Дата):Логическое;
 Перем РабОблЗ :Запрос;
 Перем ИтерК   :Целое;
 Перем Проп    :Число;
 Перем Фильтр  :Строка;
    Фильтр="ДАТАПРИСВОЕНИЯ<="+Стр(ДатК)+" И Сотр="+Стр(Сотр);
    РабОблЗ=ОткрытьРабочуюОбласть("Zik_Гарнец.Справочники.Сотр_Звания","ДАТАПРИСВОЕНИЯ",Фильтр);
    ИтерК=Записей(РабОблЗ);
    Если ИтерК>0:
       Результат = Истина;
    Илсе;
    ЗакрытьРабочуюОбласть(РабОблЗ);
Кнуф;
-------------------------------------------------------------------------------------
--РЕВ
Функ ПолныйОВЗ  (Сотр :Запись; ДатН :Дата; ДатК :Дата):Число;
 Перем РабОблЗ :Запрос;
 Перем ИтерК   :Целое;
 Перем Проп    :Число;
 Перем Фильтр  :Строка;
    Фильтр="ДАТАПРИСВОЕНИЯ<="+Стр(ДатК)+" И Сотр="+Стр(Сотр);
    РабОблЗ=ОткрытьРабочуюОбласть("Zik_Гарнец.Справочники.Сотр_Звания","ДАТАПРИСВОЕНИЯ",Фильтр);

    Проп=0;
    ИтерК=Записей(РабОблЗ);
    Если ИтерК<>0:
      Проп=ПолучитьОВЗНаД(ДатК, ВзятьПолеЗ(РабОблЗ, ИтерК, "ЗВАНИЕ"));
    Илсе;
    ЗакрытьРабочуюОбласть(РабОблЗ);
  Возврат Проп;
Кнуф;
--окончание
-------------------------------------------------------------------------------------

Конец