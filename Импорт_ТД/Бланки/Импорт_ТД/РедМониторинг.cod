Class inherited 2МашинаРеквизитов.Базовые.редБазовыйДокумент0 "Бланк Мониторинга импорта",
         editor 2Импорт_ТД.Импорт_ТД.запМониторинг0;

import 2сис2            0 classes 2исключения, строковыефункции, функцииртти, функциидокумента, функции;
import 2МашинаРеквизитов0 classes 2Библио;
Import 2       0          Classes 2Импорт_ТД.РедСоответствиеПолей0, XLS, 2СписокКартотек;

InClass 2 0Public

 var ВнешнийВызов : Logical;

 var lClass       : Класс BlankForm;
 var БланкМакета  : BlankForm;
 var 2СписокФайловДляЗагрузки0 []: String;
----------------------------------------------------------------------------
InObject Public
----------------------------------------------------------------------------
  proc шаблон_ПриОткрытии(Create :Logical);
    inherited шаблон_ПриОткрытии(Create);
    -- Вызывается при открытия окна формы
    --   Create: True - форма открывается, False - форма восстанавливается при запуске сессии
     Если ВнешнийВызов Тогда
        Внешний_Вызов("ВнешнийВызов");
        ----------------
        Close(cmCancel); -- Закрытие Тек. Бланка!!
        ----------------
     Илсе;
  end;
----------------------------------------------------------------------------
  func Внешний_Вызов                      (Вызывающий:Строка ) : Логическое;
    перем Sender :Button;
       Если Вызывающий="" тогда

       Иначе
           Sender.Caption = "2ВнешнийВызов0";
           Button1OnClick( Sender );
       конец;
    Result = true; -- Разрешаем переключение
  end;
----------------------------------------------------------------------------
--  Функ Запись_Var_Бланка( БланкР :Строка; ИмяПерем:Строка; ЗначПерем:Вариант): Логическое;
--   Перем lClass      : Класс BlankForm;
--   Перем БланкМакета : BlankForm;
--   Перем ВремБланк   : BlankForm;
--
--      lClass = СИС2.ФункцииКонсоли.НайтиФормуБланка(БланкР);
--      If lClass = nil Then
--         Return Ложь;
--      Иначе
--          БланкМакета  = lClass.Создать;
--          ВремБланк    = БланкМакета;
--          если БланкМакета.ObjectsCount=1 тогда
--              --???
--          Иначе
--              БланкМакета = nil ;
--              БланкМакета = ВремБланк.Objects[1];    -- БланкМакета.ObjectsCount
--          конец;
--          БланкМакета.ВнешнийВызов = Истина;
--          --Вычислить("БланкМакета."+ ИмяПерем + "=" + str(ЗначПерем) );
--          --Вычислить("" + БланкМакета +"."+ ИмяПерем + "=" + str(ЗначПерем) );
--
--         Return Истина;
--      End;
--
--  Кнуф;
----------------------------------------------------------------------------
  proc Button1OnClick                    (Sender :Button);
    var i, FieldsCount  : integer;
    var Z, x            : integer;
    var lRec: record;
    var lField : Запись ;
    var БланкРед    : string ;
    var lClass      : Класс BlankForm;
    var БланкМакета :       BlankForm;
--       ТекущНастройка  = картСоответствийЗапись как Запись;
       БланкРед = БланкРедСоответствийСтр;

       2Е0сли Позиции.Количество=0 тогда
        -----------------------------
       Иначе
        --------ОБРАБОТЧИК СТРОК-----
        -- ............
         2Е0сли Sender.Caption = "2ВнешнийВызов0" тогда

         Иначе
            FieldsCount = Позиции.Количество;

--Перем ЭтоПапкаСФайлами     : Логическое;
--Перем ЗаписываемыйДокумент : Запись;
--Перем ЧитаемФайлИзПапки    : Строка;
--2СписокФайловДляЗагрузки0  []: Строка;

        --lClass       = СИС2.ФункцииКонсоли.НайтиФормуБланка(БланкРед);
        lClass       = ФормаБланкаСоотв;
        БланкМакета  = lClass.Создать;
        БланкМакета.ВнешнийВызов         = Истина ;

--{     ПРЕДВАРИТЕЛЬНОЕ ОТКРЫТИЕ БЛАНКА!!!!
        БланкМакета.2Предворительный0Вызов = Истина;
        lField = Позиции[1].GetField("Настройка");
        OpenBlankEditor( БланкРед, lField);

        Если 2ГрупповаяОбработкаДокументов0 Тогда
          2СписокФайловДляЗагрузки0 = БланкМакета.2СписокФайловДляЗагрузки0 как Строка[];
          Z = ДлинаМассива(2СписокФайловДляЗагрузки0);
        Иначе
          Z = 1;
        Илсе;
        БланкМакета.2Предворительный0Вызов = Ложь;
--}     ПРЕДВАРИТЕЛЬНОЕ ОТКРЫТИЕ БЛАНКА!!!!

           for x = 1.. Z do                                     --Цикл по Документам в Папке (Если это папка)
              Если 2ГрупповаяОбработкаДокументов0 Тогда
                 ЧитаемФайлИзПапки = 2СписокФайловДляЗагрузки0 [x];
              Илсе;
              for i = 1..FieldsCount do                         --Цикл по позициям в "Мониторинге"!
                 lField = Позиции[i].GetField("Настройка");
                 Попытка
                   OpenBlankEditor( БланкРед, lField);
                 Исключение
                   --Получилось не то, что хотел...
                   БланкМакета.ВнешнийВызов = Ложь;
                   БланкМакета.2ГрупповаяОбработкаДокументов0 = Ложь;
                   БланкМакета              = Nil ;
                   Трассировка("Ошибка обработки строки - "+ Стр(lField) );
                   ПРЕРВАТЬ;
                 Конец;
                 -------
                 Если i = 1 Тогда   --В том случае, если пишем в Подтаблицу
                   lRec = БланкМакета.ЗаписываемыйДокумент;
                   Трассировка("Записываемый Документ=" + Стр(lRec) );
                 Иначе
                   БланкМакета.ЗаписываемыйДокумент = lRec;
                 Илсе;
                 -------
              Od; --for i = 2..FieldsCount do

              Если БланкМакета = Nil Тогда
                 ПРЕРВАТЬ;
              Илсе;

           Od; --for x = 1.. Z do        --Цикл по Документам в Папке
--              lClass = СИС2.ФункцииКонсоли.НайтиФормуБланка(БланкРед);
--              БланкМакета  = lClass.Создать;
          Если БланкМакета <> Nil Тогда
            БланкМакета.ВнешнийВызов = Ложь;
            БланкМакета.2ГрупповаяОбработкаДокументов0 = Ложь;
            БланкМакета              = Nil ;
          Илсе;

          Если Excel <> Nil Тогда
            ЗакрытьExcel(Excel);
          Илсе;

         конец;
         -- ............
        -----------------------------
       конец;
  end;
----------------------------------------------------------------------------
  func ПолеЗаголовокОкнаФормы_ПриВыводе  (Cell :TemplateCell; Value :Variant; Action :Template.OutputTypes; var Format :String) :String;
      -- Обработка вывода значения поля в зависимости от типа события
      -- Параметры:
      --           Cell2   0: клетка шаблона
      --           Value2  0: значение в поле клетки
      --           Action2 0: тип вывода (Вывод,Вычисление,Копирование,Экспорт)
      --           Format2 0: строка-формат вывода значения
    Result = inherited ПолеЗаголовокОкнаФормы_ПриВыводе(Cell, Value, Action, Format);
    Result = Value; -- Что получили, то и выводим
  end;
----------------------------------------------------------------------------
----------------------------------------------------------------------------
----------------------------------------------------------------------------
END
